# Requirements Document

## Introduction

Flux is a lightweight, private web-based messenger designed exclusively for small friend groups and school use. The system prioritizes simplicity, safety, and ephemeral communication without traditional authentication mechanisms. Users join rooms via invite links or room codes, exchange real-time messages, and benefit from automatic message expiration to maintain privacy.

## Glossary

- **Flux System**: The complete backend messenger application including REST API and WebSocket server
- **User**: An individual participant identified by a nickname without traditional authentication
- **Room**: A chat space where users can exchange messages, identified by a unique code
- **Message**: A communication unit that can be of type normal, system, fake, image, poll, or file
- **Invite Link**: A URL containing a room identifier that allows direct room access
- **Room Code**: A short alphanumeric identifier used to join a room
- **System Message**: An automated message generated by the Flux System for warnings or alerts
- **Fake Message**: A temporary message injected for demonstration purposes that is not persisted
- **Message Expiration**: The automatic deletion of messages after a configured time period
- **Room Lock**: A state where a room becomes read-only, preventing new messages
- **Reaction**: An emoji response to a message that expresses emotion without text
- **Pinned Message**: A message marked as important and displayed in a dedicated section
- **Typing Indicator**: A real-time notification showing when users are composing messages
- **Poll**: An interactive message allowing users to vote on options
- **Moderator**: A user with elevated permissions to manage room content and participants
- **Theme**: A visual appearance configuration including colors and fonts
- **Edited Message**: A message that has been modified after initial sending
- **Deleted Message**: A message that has been removed, showing a tombstone placeholder

## Requirements

### Requirement 1

**User Story:** As a user, I want to join rooms without creating an account, so that I can quickly start chatting with my friends.

#### Acceptance Criteria

1. WHEN a user receives an invite link, THE Flux System SHALL allow the user to join the room by providing only a nickname
2. WHEN a user enters a valid room code and nickname, THE Flux System SHALL grant access to the room
3. WHEN a user attempts to join with an empty nickname, THE Flux System SHALL reject the request and maintain the current state
4. WHEN a user joins a room, THE Flux System SHALL broadcast a system message to all room participants indicating the new user has joined

### Requirement 2

**User Story:** As a room creator, I want to create and manage rooms with configurable limits, so that I can control the size of my chat group.

#### Acceptance Criteria

1. WHEN a user creates a room, THE Flux System SHALL generate a unique room code and return an invite link
2. WHEN a room reaches its maximum user capacity, THE Flux System SHALL reject new join requests
3. WHEN a user leaves a room, THE Flux System SHALL remove the user from the participant list and broadcast a system message
4. WHEN a room creator configures a maximum user limit, THE Flux System SHALL enforce that limit for all subsequent join attempts
5. WHEN a user queries room information, THE Flux System SHALL return the current participant count and maximum capacity

### Requirement 3

**User Story:** As a user, I want to send and receive messages in real-time, so that I can have fluid conversations with my group.

#### Acceptance Criteria

1. WHEN a user sends a message to a room, THE Flux System SHALL broadcast the message to all connected room participants immediately
2. WHEN a user connects to a room, THE Flux System SHALL deliver all non-expired messages from that room
3. WHEN a message is created, THE Flux System SHALL assign a timestamp and unique identifier to the message
4. WHEN a message reaches its expiration time, THE Flux System SHALL remove the message from storage
5. WHEN a user sends a message to a locked room, THE Flux System SHALL reject the message if the user is not a moderator

### Requirement 4

**User Story:** As a system administrator, I want the system to automatically display safety warnings, so that users are reminded not to share personal information.

#### Acceptance Criteria

1. WHEN a user joins a room, THE Flux System SHALL display a system message warning against sharing personal information
2. WHEN a room is created, THE Flux System SHALL include the safety banner as the first system message
3. WHEN system messages are generated, THE Flux System SHALL mark them with type system to distinguish them from user messages

### Requirement 5

**User Story:** As a user, I want to clear chat history, so that I can remove unwanted messages from my view or for everyone.

#### Acceptance Criteria

1. WHEN a user triggers a clear chat for everyone action, THE Flux System SHALL delete all messages in the room and broadcast the deletion to all participants
2. WHEN a user triggers a clear chat locally action, THE Flux System SHALL send a signal to that specific user client without affecting other participants
3. WHEN messages are cleared for everyone, THE Flux System SHALL preserve the safety banner system message
4. WHEN a clear chat action completes, THE Flux System SHALL broadcast a system message confirming the action

### Requirement 6

**User Story:** As a teacher or demonstrator, I want to inject fake messages for demonstration purposes, so that I can show examples without creating permanent records.

#### Acceptance Criteria

1. WHEN a fake message is injected, THE Flux System SHALL broadcast the message to all connected room participants
2. WHEN a fake message is created, THE Flux System SHALL mark it with type fake to distinguish it from normal messages
3. WHEN the Flux System stores messages, THE Flux System SHALL exclude fake messages from persistent storage
4. WHEN a user disconnects and reconnects, THE Flux System SHALL not deliver previously sent fake messages

### Requirement 7

**User Story:** As a room moderator, I want to lock a room to read-only mode, so that I can prevent disruptions during important announcements.

#### Acceptance Criteria

1. WHEN a moderator locks a room, THE Flux System SHALL set the room state to read-only
2. WHILE a room is locked, THE Flux System SHALL reject message send attempts from non-moderator users
3. WHEN a moderator unlocks a room, THE Flux System SHALL restore normal messaging capabilities
4. WHEN a room lock state changes, THE Flux System SHALL broadcast a system message to all participants

### Requirement 8

**User Story:** As a privacy-conscious user, I want messages to automatically expire, so that my conversations are not stored indefinitely.

#### Acceptance Criteria

1. WHEN a message is created with an expiration time, THE Flux System SHALL automatically delete the message after the specified duration
2. WHEN message expiration is configured at the system level, THE Flux System SHALL apply the expiration time to all new messages
3. WHEN storage is disabled completely, THE Flux System SHALL only maintain messages in memory for active connections
4. WHEN a message expires, THE Flux System SHALL remove it from all storage mechanisms without broadcasting a deletion event

### Requirement 9

**User Story:** As a developer integrating with Flux, I want clear REST and WebSocket APIs, so that I can easily build client applications.

#### Acceptance Criteria

1. WHEN a client requests API documentation, THE Flux System SHALL provide endpoint descriptions and expected parameters
2. WHEN a WebSocket event is emitted, THE Flux System SHALL use clearly named event types that describe the action
3. WHEN an API error occurs, THE Flux System SHALL return structured error responses with descriptive messages
4. WHEN a client connects via WebSocket, THE Flux System SHALL require room identification before allowing message operations

### Requirement 10

**User Story:** As a user, I want to share images in chat, so that I can communicate visually with my group.

#### Acceptance Criteria

1. WHEN a user uploads an image file, THE Flux System SHALL accept common image formats including JPEG, PNG, GIF, and WebP
2. WHEN an image is uploaded, THE Flux System SHALL validate the file size does not exceed the maximum limit
3. WHEN an image is uploaded, THE Flux System SHALL upload the image to Supabase storage and obtain a public URL
4. WHEN an image message is created, THE Flux System SHALL store the image URL and broadcast it to all room participants
5. WHEN a user receives an image message, THE Flux System SHALL deliver the image URL for display
6. WHEN images expire with their messages, THE Flux System SHALL remove the image reference from storage

### Requirement 11

**User Story:** As a user, I want to chat with an AI assistant in my room, so that I can get help or have fun conversations.

#### Acceptance Criteria

1. WHEN a user sends a message mentioning the AI bot, THE Flux System SHALL forward the message to the AI service
2. WHEN the AI service responds, THE Flux System SHALL broadcast the AI response as a message in the room
3. WHEN an AI message is created, THE Flux System SHALL mark it with a distinct sender identifier indicating it is from the AI
4. WHEN the AI service is unavailable, THE Flux System SHALL send a system message indicating the AI is offline
5. WHEN a user requests AI chat, THE Flux System SHALL use a free AI API service without requiring authentication

### Requirement 12

**User Story:** As a user, I want quick action buttons for common tasks, so that I can quickly manage my chat experience.

#### Acceptance Criteria

1. WHEN a user triggers the panic button, THE Flux System SHALL immediately clear all messages for that user locally and disconnect them from the room
2. WHEN a user triggers the clear button, THE Flux System SHALL clear all messages in the room for everyone
3. WHEN a user triggers the spoof button, THE Flux System SHALL inject a fake message appearing to be from a trusted source such as Google or Wikipedia
4. WHEN a spoofed message is created, THE Flux System SHALL mark it with type fake and include a recognizable sender name like Google or Wikipedia
5. WHEN any quick action button is triggered, THE Flux System SHALL execute the action within one second
6. WHEN the panic button is triggered, THE Flux System SHALL not broadcast any notification to other users

### Requirement 13

**User Story:** As a user, I want to edit my sent messages, so that I can correct mistakes or update information.

#### Acceptance Criteria

1. WHEN a user edits their own message, THE Flux System SHALL update the message content and mark it as edited
2. WHEN a message is edited, THE Flux System SHALL broadcast the updated message to all room participants
3. WHEN a user attempts to edit another user's message, THE Flux System SHALL reject the request
4. WHEN an edited message is displayed, THE Flux System SHALL show an edited indicator with the edit timestamp
5. WHEN a message is older than 48 hours, THE Flux System SHALL prevent editing

### Requirement 14

**User Story:** As a user, I want to delete my sent messages, so that I can remove unwanted content.

#### Acceptance Criteria

1. WHEN a user deletes their own message, THE Flux System SHALL remove the message from storage and broadcast the deletion
2. WHEN a message is deleted, THE Flux System SHALL display a deleted message placeholder to all participants
3. WHEN a user attempts to delete another user's message, THE Flux System SHALL reject the request unless the user is a moderator
4. WHEN a moderator deletes any message, THE Flux System SHALL remove it and broadcast the deletion
5. WHEN a deleted message is displayed, THE Flux System SHALL show a tombstone indicator

### Requirement 15

**User Story:** As a user, I want to react to messages with emojis, so that I can express emotions quickly without typing.

#### Acceptance Criteria

1. WHEN a user adds a reaction to a message, THE Flux System SHALL store the reaction and broadcast it to all participants
2. WHEN a user removes a reaction, THE Flux System SHALL delete the reaction and broadcast the update
3. WHEN multiple users react with the same emoji, THE Flux System SHALL group reactions and display the count
4. WHEN a message displays reactions, THE Flux System SHALL show all unique reactions with their counts
5. WHEN a user clicks on a reaction count, THE Flux System SHALL display the list of users who reacted

### Requirement 16

**User Story:** As a user, I want to pin important messages, so that they remain easily accessible at the top of the chat.

#### Acceptance Criteria

1. WHEN a moderator pins a message, THE Flux System SHALL mark the message as pinned and broadcast the update
2. WHEN a message is pinned, THE Flux System SHALL display it in a dedicated pinned messages section
3. WHEN a moderator unpins a message, THE Flux System SHALL remove it from the pinned section
4. WHEN a room has multiple pinned messages, THE Flux System SHALL display them in chronological order
5. WHEN a non-moderator attempts to pin a message, THE Flux System SHALL reject the request

### Requirement 17

**User Story:** As a user, I want to see typing indicators, so that I know when others are composing messages.

#### Acceptance Criteria

1. WHEN a user starts typing, THE Flux System SHALL broadcast a typing indicator to all room participants
2. WHEN a user stops typing for 3 seconds, THE Flux System SHALL remove the typing indicator
3. WHEN a user sends a message, THE Flux System SHALL immediately remove their typing indicator
4. WHEN multiple users are typing, THE Flux System SHALL display all active typing indicators
5. WHEN displaying typing indicators, THE Flux System SHALL show user nicknames

### Requirement 18

**User Story:** As a user, I want to create and participate in polls, so that I can gather opinions from the group.

#### Acceptance Criteria

1. WHEN a user creates a poll, THE Flux System SHALL broadcast the poll to all room participants
2. WHEN a user votes in a poll, THE Flux System SHALL record the vote and broadcast the updated results
3. WHEN a poll is displayed, THE Flux System SHALL show the question, options, and current vote counts
4. WHEN a user has already voted, THE Flux System SHALL prevent duplicate votes
5. WHEN a poll creator closes a poll, THE Flux System SHALL mark it as closed and display final results

### Requirement 19

**User Story:** As a user, I want to send GIFs and files, so that I can share more types of content.

#### Acceptance Criteria

1. WHEN a user uploads a GIF file, THE Flux System SHALL accept the file and display it inline
2. WHEN a user uploads a document file, THE Flux System SHALL accept common formats including PDF, DOC, TXT, and ZIP
3. WHEN a file is uploaded, THE Flux System SHALL validate the file size does not exceed 10MB
4. WHEN a file message is created, THE Flux System SHALL store the file URL and metadata
5. WHEN a user receives a file message, THE Flux System SHALL display a download link with file information

### Requirement 20

**User Story:** As a user, I want to customize the chat appearance, so that I can personalize my experience.

#### Acceptance Criteria

1. WHEN a user selects a theme, THE Flux System SHALL apply the theme to the chat interface
2. WHEN a user changes the accent color, THE Flux System SHALL update all accent elements
3. WHEN a user adjusts the message bubble color, THE Flux System SHALL apply the color to their sent messages
4. WHEN a user changes the font size, THE Flux System SHALL scale all text accordingly
5. WHEN theme settings are changed, THE Flux System SHALL persist the preferences locally

### Requirement 21

**User Story:** As a user, I want to control notifications, so that I can manage interruptions.

#### Acceptance Criteria

1. WHEN a user enables notifications, THE Flux System SHALL request browser notification permissions
2. WHEN a new message arrives and notifications are enabled, THE Flux System SHALL display a browser notification
3. WHEN a user disables notifications, THE Flux System SHALL stop sending browser notifications
4. WHEN a user is mentioned in a message, THE Flux System SHALL send a high-priority notification
5. WHEN notification settings are changed, THE Flux System SHALL persist the preferences locally

### Requirement 22

**User Story:** As a room creator, I want to regenerate the invite link, so that I can revoke access to the old link.

#### Acceptance Criteria

1. WHEN a moderator regenerates the invite link, THE Flux System SHALL create a new unique room code
2. WHEN the invite link is regenerated, THE Flux System SHALL invalidate the old room code
3. WHEN the new invite link is created, THE Flux System SHALL broadcast the update to all current participants
4. WHEN a user attempts to join with an old room code, THE Flux System SHALL reject the request
5. WHEN the invite link is regenerated, THE Flux System SHALL maintain all existing participants and messages
