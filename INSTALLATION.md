# Installation Guide - WebServer Guard Module

## Prerequisites

- Rooted Android device (Android 5.0+)
- Magisk installed (v20.4+)
- ADB tools (optional, for command-line installation)
- Basic terminal knowledge

## Quick Installation

### Via Magisk Manager (Easiest)

1. **Download the module**
   - Get `WebServerGuard.zip` from releases

2. **Open Magisk Manager**
   - Launch the Magisk app on your device

3. **Install module**
   - Tap **Modules** (bottom navigation)
   - Tap **Install from storage** (floating action button)
   - Navigate to and select `WebServerGuard.zip`
   - Wait for installation to complete

4. **Reboot**
   - Tap **Reboot** when prompted
   - Module will activate on next boot

## Advanced Installation

### Via ADB (For Developers)

```bash
# 1. Connect device via USB
adb devices

# 2. Push module to device
adb push WebServerGuard.zip /sdcard/Download/

# 3. Install via Magisk CLI
adb shell su -c "magisk --install-module /sdcard/Download/WebServerGuard.zip"

# 4. Reboot device
adb reboot
```

### Via Terminal Emulator (On-Device)

```bash
# 1. Open Termux or any terminal emulator
# 2. Gain root access
su

# 3. Install module
magisk --install-module /sdcard/Download/WebServerGuard.zip

# 4. Reboot
reboot
```

## Creating the Module ZIP

If you're building from source:

```bash
# 1. Ensure all files have correct permissions
chmod 755 customize.sh
chmod 755 post-fs-data.sh
chmod 755 service.sh
chmod 755 uninstall.sh
chmod 755 scripts/*.sh

# 2. Create ZIP structure
zip -r WebServerGuard.zip \
    META-INF/ \
    module.prop \
    customize.sh \
    post-fs-data.sh \
    service.sh \
    uninstall.sh \
    system.prop \
    sepolicy.rule \
    scripts/ \
    webroot/ \
    README.md

# 3. Verify ZIP contents
unzip -l WebServerGuard.zip
```

Expected structure:
```
WebServerGuard.zip
├── META-INF/
│   └── com/google/android/
│       ├── update-binary (auto-generated by Magisk)
│       └── updater-script
├── module.prop
├── customize.sh
├── post-fs-data.sh
├── service.sh
├── uninstall.sh
├── system.prop
├── sepolicy.rule
├── scripts/
│   ├── webserver_watchdog.sh
│   ├── protection_daemon.sh
│   ├── logcat_monitor.sh
│   └── protect_manager.sh
├── webroot/
│   └── index.html
└── README.md
```

## Post-Installation Verification

### 1. Check Module Status

```bash
# Via Magisk Manager
# Open Magisk → Modules
# Verify "WebServer Guard & Process Protector" is listed and enabled

# Via command line
su -c "ls -la /data/adb/modules/android.webserver.guard/"
```

### 2. Verify Services Running

```bash
# Check web server
su -c "ps -A | grep httpd"

# Check protection daemon
su -c "ps -A | grep protection_daemon"

# Check watchdog
su -c "ps -A | grep webserver_watchdog"
```

### 3. Test Web Server

```bash
# From device
curl http://localhost

# Expected output: HTML content from index.html

# Check port binding
su -c "netstat -tlnp | grep 8080"
```

### 4. Check Logs

```bash
# View installation log
su -c "cat /data/local/tmp/webserver_module.log"

# Should show:
# - POST-FS-DATA STARTED
# - SERVICE SCRIPT STARTED
# - Web server started
# - Protection daemon started
# - Watchdog started
```

### 5. Verify Process Protection

```bash
# Check Termux OOM score
TERMUX_PID=$(pgrep -f com.termux | head -n 1)
su -c "cat /proc/$TERMUX_PID/oom_score_adj"

# Expected output: -1000
```

## First-Time Setup

### 1. Access Protection Manager

```bash
su -c /data/adb/modules/android.webserver.guard/scripts/protect_manager.sh
```

### 2. Add Protected Processes

```
Select option: 2
Enter process name: com.termux
✓ Added 'com.termux' to protection list
```

### 3. Verify Protection Status

```
Select option: 6

Protection Status:
------------------
  Protection Daemon: ✓ Running
  Web Server Watchdog: ✓ Running
  Web Server: ✓ Running (PID: 12345, OOM: -1000)
  Termux: ✓ Running (PID: 12346, OOM: -1000)
  Protected Processes: 1
```

### 4. Test Web Server

```bash
# From device
curl http://localhost

# From network (replace with your device IP)
curl http://192.168.1.100

# Expected: HTML page with "WebServer Guard Active"
```

## Troubleshooting Installation

### Module Not Showing in Magisk

**Cause**: ZIP structure incorrect or module.prop invalid

**Solution**:
```bash
# Verify ZIP structure
unzip -l WebServerGuard.zip | head -20

# Check module.prop format
unzip -p WebServerGuard.zip module.prop

# Ensure Unix line endings (LF, not CRLF)
dos2unix module.prop
```

### Installation Fails with "Unsupported Architecture"

**Cause**: Device architecture not detected

**Solution**:
```bash
# Check device architecture
adb shell getprop ro.product.cpu.abi

# Supported: armeabi-v7a, arm64-v8a, x86, x86_64, riscv64
```

### Module Installed but Not Working

**Cause**: Scripts not executable or SELinux blocking

**Solution**:
```bash
# Fix permissions
su -c "chmod 755 /data/adb/modules/android.webserver.guard/*.sh"
su -c "chmod 755 /data/adb/modules/android.webserver.guard/scripts/*.sh"

# Check SELinux denials
su -c "dmesg | grep denied | grep webserver"

# Temporarily disable SELinux (for testing only)
su -c "setenforce 0"
```

### Web Server Not Starting

**Cause**: Port conflict or BusyBox not found

**Solution**:
```bash
# Check if port 8080 is in use
su -c "netstat -tlnp | grep 8080"

# Kill conflicting process
su -c "kill -9 <PID>"

# Verify BusyBox exists
su -c "ls -la /data/adb/magisk/busybox"

# Manually start web server
su -c "/data/adb/magisk/busybox httpd -p 8080 -h /data/adb/modules/android.webserver.guard/webroot -f"
```

### Scripts Not Running After Boot

**Cause**: Boot scripts not executable or boot sequence issue

**Solution**:
```bash
# Check boot logs
su -c "logcat -d | grep webserver"

# Manually run service script
su -c "/data/adb/modules/android.webserver.guard/service.sh"

# Check for errors in log
su -c "cat /data/local/tmp/webserver_module.log"
```

## Updating the Module

### Method 1: Reinstall

1. Remove old version from Magisk Manager
2. Reboot
3. Install new version
4. Reboot

### Method 2: Direct Update (Preserves Settings)

```bash
# Backup protected list
su -c "cp /data/adb/modules/android.webserver.guard/protected.list /sdcard/"

# Install new version
su -c "magisk --install-module /sdcard/WebServerGuard_v2.zip"

# Restore protected list
su -c "cp /sdcard/protected.list /data/adb/modules/android.webserver.guard/"

# Reboot
reboot
```

## Uninstallation

### Via Magisk Manager

1. Open Magisk Manager
2. Go to **Modules**
3. Find **WebServer Guard & Process Protector**
4. Tap **Remove**
5. Reboot

### Via Command Line

```bash
# Remove module
su -c "rm -rf /data/adb/modules/android.webserver.guard"

# Reboot
su -c "reboot"
```

### Manual Cleanup (If Needed)

```bash
# Stop services
su -c "killall httpd"
su -c "pkill -f protection_daemon"
su -c "pkill -f webserver_watchdog"

# Remove iptables rules
su -c "iptables -t nat -D OUTPUT -p tcp --dport 80 -j REDIRECT --to-ports 8080"
su -c "iptables -t nat -D PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080"

# Remove logs (optional)
su -c "rm -rf /data/local/tmp/webserver_*"
```

## Next Steps

After successful installation:

1. **Read the README**: `README.md` for full feature documentation
2. **Configure Protection**: Add processes to protect using the manager
3. **Customize Web Content**: Replace files in `webroot/` directory
4. **Monitor Logs**: Check `/data/local/tmp/webserver_module.log` regularly
5. **Test Persistence**: Kill processes and verify auto-restart

## Support

If you encounter issues:

1. Check logs: `/data/local/tmp/webserver_module.log`
2. Verify Magisk version: v20.4+
3. Check Android version: 5.0+
4. Review SELinux status: `getenforce`
5. Test with SELinux permissive: `setenforce 0`

---

**Installation Complete!** Your device is now a persistent web server with advanced process protection.
